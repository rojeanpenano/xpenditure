<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transaction Management</title>
    <link rel="stylesheet" href="transact.css">
</head>
<body>
    <h1>Transaction Management</h1>

    <!-- Section to Add a Transaction -->
    <section id="addTransactionSection">
        <h2>Add Transaction</h2>
        <form id="transactionForm">
            <!-- Input for Amount -->
            <label for="amount">Amount:</label>
            <input type="number" id="amount" name="amount" required>

            <!-- Dropdown for Category -->
            <label for="category">Category:</label>
            <select id="category" name="category" required>
                <option value="">--Select Category--</option>
                <option value="Food">Food</option>
                <option value="Rent">Rent</option>
                <option value="Transportation">Transportation</option>
                <option value="Utilities">Utilities</option>
                <option value="Others">Others</option>
            </select>

            <!-- Input for Description -->
            <label for="description">Description:</label>
            <input type="text" id="description" name="description" required>

            <!-- Input for Date -->
            <label for="date">Date:</label>
            <input type="date" id="date" name="date" required>

            <!-- Submit Button -->
            <button type="submit">Add Transaction</button>
        </form>
    </section>

    <!-- Section to View Transactions -->
    <section id="viewTransactionsSection">
        <h2>All Transactions</h2>
        <button id="viewTransactionsButton">View Transactions</button>
        <table id="transactionsTable">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Amount</th>
                    <th>Category</th>
                    <th>Description</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </section>

    <!-- Section for Summaries -->
    <section id="summarySection">
        <h2>Expense Summaries</h2>
        <button id="categorizedSummaryButton">View Categorized Summary</button>
        <button id="monthlySummaryButton">View Monthly Summary</button>
        <div id="summaryOutput"></div>
    </section>

    <script>
        // Event listener for adding a transaction
        document.getElementById('transactionForm').addEventListener('submit', async (event) => {
            event.preventDefault(); // Prevent default form submission behavior

            // Collect form data
            const amount = document.getElementById('amount').value.trim();
            const category = document.getElementById('category').value.trim();
            const description = document.getElementById('description').value.trim();
            const date = document.getElementById('date').value.trim();

            // Debug: Log collected data
            console.log({ amount, category, description, date });

            // Client-side validation to ensure no fields are empty
            if (!amount || !category || !description || !date) {
                alert('All fields are required.');
                return; // Stop execution if validation fails
            }

            try {
                const token = localStorage.getItem('token'); // Retrieve JWT token
                const response = await fetch('http://localhost:5000/api/transactions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`,
                    },
                    body: JSON.stringify({ amount, category, description, date }), // Send form data
                });

                const data = await response.json();
                if (response.ok) {
                    alert('Transaction added successfully!');
                    document.getElementById('transactionForm').reset(); // Clear the form
                } else {
                    alert(data.message || 'Failed to add transaction');
                }
            } catch (error) {
                alert('Error: Unable to connect to the server.');
            }
        });

        // Event listener to view all transactions
        document.getElementById('viewTransactionsButton').addEventListener('click', async () => {
            try {
                const token = localStorage.getItem('token'); // Retrieve JWT token
                const response = await fetch('http://localhost:5000/api/transactions', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                    },
                });

                const transactions = await response.json();
                if (response.ok) {
                    const tableBody = document.querySelector('#transactionsTable tbody');
                    tableBody.innerHTML = ''; // Clear existing rows

                    transactions.forEach((transaction) => {
                        const row = `
                            <tr>
                                <td>${transaction.date}</td>
                                <td>${transaction.amount}</td>
                                <td>${transaction.category}</td>
                                <td>${transaction.description}</td>
                            </tr>
                        `;
                        tableBody.innerHTML += row;
                    });
                } else {
                    alert(transactions.message || 'Failed to fetch transactions');
                }
            } catch (error) {
                alert('Error: Unable to connect to the server.');
            }
        });

        // Categorized Expense Summary
        document.getElementById('categorizedSummaryButton').addEventListener('click', async () => {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('http://localhost:5000/api/transactions/categorized-summary', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                    },
                });

                const summary = await response.json();
                if (response.ok) {
                    document.getElementById('summaryOutput').innerText = JSON.stringify(summary, null, 2);
                } else {
                    alert(summary.message || 'Failed to fetch categorized summary');
                }
            } catch (error) {
                alert('Error: Unable to connect to the server.');
            }
        });

        // Monthly Expense Summary
        document.getElementById('monthlySummaryButton').addEventListener('click', async () => {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('http://localhost:5000/api/transactions/monthly-summary', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                    },
                });

                const summary = await response.json();
                if (response.ok) {
                    document.getElementById('summaryOutput').innerText = JSON.stringify(summary, null, 2);
                } else {
                    alert(summary.message || 'Failed to fetch monthly summary');
                }
            } catch (error) {
                alert('Error: Unable to connect to the server.');
            }
        });
    </script>
</body>
</html>
